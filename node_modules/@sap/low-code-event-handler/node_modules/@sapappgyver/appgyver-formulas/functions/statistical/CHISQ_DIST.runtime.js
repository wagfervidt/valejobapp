/* eslint-disable no-bitwise,no-plusplus */
const gammaLN = require('./GAMMALN.runtime');

const lowRegGamma = (a, x) => {
  const aln = gammaLN([a]);
  let ap = a;
  let sum = 1 / a;
  let del = sum;
  let b = x + 1 - a;
  let c = 1 / 1.0e-30;
  let d = 1 / b;
  let h = d;
  let i = 1;
  // calculate maximum number of itterations required for a
  const ITMAX = -~(Math.log((a >= 1) ? a : 1 / a) * 8.5 + a * 0.4 + 17);
  let an;

  if (x < 0 || a <= 0) {
    return null;
  }
  if (x < a + 1) {
    for (; i <= ITMAX; i++) {
      ap += 1;
      del *= (x / ap);
      sum += del;
    }
    return (sum * Math.exp(-x + a * Math.log(x) - (aln)));
  }

  for (; i <= ITMAX; i++) {
    an = -i * (i - a);
    b += 2;
    d = an * d + b;
    c = b + an / c;
    d = 1 / d;
    h *= (d * c);
  }
  return (1 - h * Math.exp(-x + a * Math.log(x) - (aln)));
};

const distributionChiSquared = (x, dof) => {
  if (x < 0) {
    return 0;
  }
  return (x === 0 && dof === 2)
    ? 0.5
    : Math.exp((dof / 2 - 1) * Math.log(x) - x / 2 - (dof / 2)
      * Math.log(2) - gammaLN([dof / 2]));
};

const cumulativeChiSquared = (x, dof) => {
  if (x < 0) {
    return 0;
  }
  return lowRegGamma(dof / 2, x / 2);
};

module.exports = ([num, degrees, cumulative]) => {
  if (!(typeof num === 'number' && Number.isFinite(num))) {
    return null;
  }
  if (!(typeof degrees === 'number' && Number.isFinite(degrees))) {
    return null;
  }
  const result = cumulative
    ? cumulativeChiSquared(num, degrees)
    : distributionChiSquared(num, degrees);
  return Number.isFinite(result) ? result : null;
};
