const { isSame } = require('@sapappgyver/appgyver-schemas/utils/equality');

module.exports = (inv) => {
  const { params: [array, prop], result: propValue } = inv;
  if (!Array.isArray(array)) {
    throw new Error('Cannot invert an item of non-list');
  }
  if (typeof prop !== 'number') {
    throw new Error('Cannot invert with non-number array index');
  }
  if (prop < 0 || !Number.isFinite(prop)) {
    throw new Error(`Cannot invert at index ${prop}`);
  }
  const currentValue = array[prop];
  if (isSame(propValue, currentValue)) {
    return inv.invertNothing();
  }
  const newArray = array.slice();
  newArray[prop] = propValue;
  newArray.fill(undefined, array.length, prop - 1);
  return inv.invertTo(newArray);
};
