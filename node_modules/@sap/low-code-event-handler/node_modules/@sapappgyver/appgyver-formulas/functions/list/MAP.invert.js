const { invertMap } = require('../../utils/array');

module.exports = (inv) => {
  const { params: [originalArray, ...params], result: updatedArray } = inv;
  const invertItem = inv.getParamInverter(1, 'Cannot invert MAP with non-inversible mapping formula');
  const sideEffects = [];
  const invertedArray = invertMap(
    originalArray,
    updatedArray,
    (updatedItem, originalItem, index) => {
      const [invertedNestedParams, updates] = invertItem([originalItem, index], updatedItem);
      sideEffects.push(updates);
      if (invertedNestedParams[1] !== index) {
        throw new Error(`Cannot invert the index ${index} to ${invertedNestedParams[1]} in MAP`);
      }
      return invertedNestedParams[0];
    },
  );
  return inv.invertToParams([invertedArray, ...params], sideEffects);
};
