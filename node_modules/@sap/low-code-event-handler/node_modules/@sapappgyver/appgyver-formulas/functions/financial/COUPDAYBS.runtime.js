const { parseDateTime } = require('../../datetime');
const COUPPCD = require('./COUPPCD.runtime');

const daysBetween = (startDate, endDate) => Math.ceil((endDate - startDate) / 1000 / 60 / 60 / 24);

module.exports = ([settlement, maturity, frequency, convention]) => {
  if (typeof settlement !== 'string' && typeof maturity !== 'string') {
    return null;
  }
  if (typeof frequency !== 'number' && !Number.isFinite(frequency)) {
    return null;
  }
  const startDate = parseDateTime(settlement);
  const endDate = parseDateTime(maturity);
  if (startDate >= endDate) {
    return null;
  }
  if (startDate.isValid() && endDate.isValid()) {
    const basis = convention || 'us_nasd';
    const valuesBasis = ['us_nasd', 'actual', 'actual_360', 'actual_365', 'european'];
    const valuesPeriod = [1, 2, 4];
    if (!valuesBasis.includes(basis) || !valuesPeriod.includes(frequency)) {
      return null;
    }
    const aDate = COUPPCD([settlement, maturity, frequency]);
    const aDateMoment = parseDateTime(aDate);
    let sd = startDate.get('date');
    const sm = startDate.get('month') + 1;
    const sy = startDate.get('year');
    let ed = aDateMoment.get('date');
    const em = aDateMoment.get('month') + 1;
    const ey = aDateMoment.get('year');
    if (basis === 'us_nasd' || basis === 'european') {
      if (sd === 31 && ed === 31) {
        sd = 30;
        ed = 30;
      } else if (sd === 31) {
        sd = 30;
      } else if (ed === 31) {
        ed = 30;
      }
      return Math.abs((ed + em * 30 + ey * 360) - (sd + sm * 30 + sy * 360));
    }
    return daysBetween(parseDateTime(aDate), startDate);
  }
  return null;
};
