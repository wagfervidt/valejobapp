const { parseDateTime } = require('../../datetime');
const YEARFRAC = require('../date/YEARFRAC.runtime');

module.exports = ([settlement, maturity, issue, rate, price, convention]) => {
  if (typeof settlement !== 'string' && typeof maturity !== 'string'
    && typeof issue !== 'string') {
    return null;
  }
  if (typeof rate !== 'number' && !Number.isFinite(rate)
    && typeof price !== 'number' && !Number.isFinite(price)) {
    return null;
  }
  if (rate < 0 || price <= 0) {
    return null;
  }
  const startDate = parseDateTime(settlement);
  const endDate = parseDateTime(maturity);
  const issueDate = parseDateTime(issue);
  if (startDate >= endDate || issueDate > startDate) {
    return null;
  }
  if (startDate.isValid() && endDate.isValid() && issueDate.isValid()) {
    const basis = convention || 'us_nasd';
    const valuesBasis = ['us_nasd', 'actual', 'actual_360', 'actual_365', 'european'];
    if (!valuesBasis.includes(basis)) {
      return null;
    }
    const fIssMat = YEARFRAC([issue, maturity, basis]);
    const fIssSet = YEARFRAC([issue, settlement, basis]);
    const fSetMat = YEARFRAC([settlement, maturity, basis]);
    let result = 1.0 + fIssMat * rate;
    result /= price / 100.0 + fIssSet * rate;
    // eslint-disable-next-line no-plusplus
    result--;
    result /= fSetMat;
    return result;
  }
  return null;
};
