#!/usr/bin/env node
const path = require("path");
const fs = require('fs-extra');
const commandLineArgs = require('command-line-args');
const { MergeMapValidator } = require('./mergemap-validator');

const PASS_IDENTIFIER ="Pass:\n";
const FAIL_IDENTIFIER ="Fail:\n";
const optionDefinitions = [
    { name: 'baseProject', type: String, multiple: false },
	{ name: 'extProject', type: String, multiple: false },
    { name: 'logFile', type: String, multiple: false }
];

let options = commandLineArgs(optionDefinitions);
let logFilePath = options['logFile'];
if (!options['extProject']) {
    options['extProject'] = process.cwd();
}

function doValidate() {
    let extPath = options["extProject"];
    let basePath = options["baseProject"];
    let validator = new MergeMapValidator(extPath, basePath);
    return validator.validate().then(diagnostics => {
        let content = PASS_IDENTIFIER;
        if (diagnostics.length > 0) {
            content = FAIL_IDENTIFIER;
            content += "Validate Extension Point failed at the following files:\n";
            diagnostics.forEach(item => {
                content += `${item.filePath}:\n`;
                item.messages.forEach(msg => {
                    content += `${msg}\n`;
                });
            });
        }
        console.log(content);
        if (logFilePath) {
            logFilePath = path.resolve(logFilePath);
            try {
                fs.writeFileSync(logFilePath, content);
            } catch (err) {
                console.error(`Failed to write output to the file "${logFilePath}"`);
            }
        }
    });
}

module.exports = { doValidate };