#!/usr/bin/env node
const Bundler = require('./bundler').Bundler;
const bundlerArgs = require('./bundler-args');
const logger = require('../logger');
const process = require('process');
const path = require('path');
const {getRootPath} = require('../utils.js');


function doBuild() {
  console.log(JSON.stringify(bundlerArgs));
  const bundler = new Bundler(bundlerArgs);
  console.log("\n" + '[hh:mm:ss]'.timestamp + logger.getPrompt(" -- cleaning --"));
  const originalPath = process.cwd();
  const workPath = path.join(getRootPath(), '..');
  process.chdir(workPath);
  //console.log(`reset pwd from ${originalPath} to ${workPath}`);
  return bundler.cleanBuild()
    .then(function (err) {
      if (err) {
        console.error(err);
        return;
      }
      console.log("\n" + '[hh:mm:ss]'.timestamp + logger.getPrompt(" -- building --"));
      return bundler.buildClientDefinitions();
    }).finally(()=>  process.chdir(originalPath) );
};
module.exports = { doBuild };


